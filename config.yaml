name: Kostal Battery Manager
version: "1.2.0-beta.63"
slug: kostal_battery_manager
description: "Intelligente Batteriesteuerung für Kostal Plenticore Plus mit Tibber-Optimierung, Verbrauchslernen und prädiktiver Ganztags-Planung"
url: "https://github.com/SvenSteuer/kostal-battery-manager"
arch:
  - aarch64
  - amd64
  - armhf
  - armv7
  - i386
init: false
startup: application
boot: auto
host_network: true
ingress: true
ingress_port: 8099
ingress_stream: false
panel_icon: mdi:battery-charging
panel_title: Battery Manager
hassio_api: true
homeassistant_api: true
privileged:
  - SYS_RAWIO

options:
  # ============================================================================
  # Kostal Inverter Connection
  # ============================================================================
  inverter_ip: "192.168.80.76"
  inverter_port: 1502
  installer_password: ""
  master_password: ""
  max_charge_power: 3900
  battery_capacity: 10.6
  log_level: "info"
  control_interval: 30

  # ============================================================================
  # Tibber Optimization
  # ============================================================================
  enable_tibber_optimization: true
  price_threshold: 0.85
  mode_switch_hysteresis_seconds: 900  # 15 minutes (prevents frequent mode changes)

  # Automation Parameters
  auto_charge_below_soc: 98  # Charge up to this SOC (%)
  auto_safety_soc: 20  # Immediate charge if SOC falls below this (%)
  auto_optimization_enabled: true

  # Tibber Price Sensors
  tibber_price_sensor: "sensor.tibber_prices"
  tibber_price_level_sensor: "sensor.tibber_price_level_deutsch"

  # ============================================================================
  # Forecast.Solar Professional API (for PV forecast)
  # ============================================================================
  enable_forecast_solar_api: true
  forecast_solar_api_key: "3Ur5qvjhNRMhGhXm"
  forecast_solar_latitude: 50.992
  forecast_solar_longitude: 7.467

  # PV planes (roof orientations)
  forecast_solar_planes:
    - declination: 22
      azimuth: 45
      kwp: 8.96
    - declination: 22
      azimuth: -135
      kwp: 10.665

  # ============================================================================
  # Home Assistant Sensors
  # ============================================================================

  # Battery SOC (required for charge control)
  battery_soc_sensor: "sensor.zwh8_8500_battery_soc"

  # Grid energy sensors (cumulative kWh counters)
  grid_from_energy_sensor: "sensor.ksem_total_active_energy_from_grid"
  grid_to_energy_sensor: "sensor.ksem_total_active_energy_to_grid"

  # Battery energy sensors (cumulative kWh counters)
  battery_charge_from_grid_sensor: "sensor.zwh8_8500_battery_charge_from_grid_total"
  battery_charge_from_pv_sensor: "sensor.zwh8_8500_battery_charge_from_pv_total"
  battery_discharge_sensor: "sensor.zwh8_8500_battery_discharge_total"

  # PV energy sensors (cumulative kWh counters from inverters)
  pv_energy_pv1_inverter1_sensor: "sensor.zwh8_8500_energy_pv1_total"
  pv_energy_pv2_inverter1_sensor: "sensor.zwh8_8500_energy_pv2_total"
  pv_energy_pv1_inverter2_sensor: "sensor.zhw8_7000_energy_pv1_total"
  pv_energy_pv2_inverter2_sensor: "sensor.zhw8_7000_energy_pv2_total"

  # ============================================================================
  # Consumption Learning
  # ============================================================================
  enable_consumption_learning: true
  learning_period_days: 28  # 4 weeks learning period

  # Optional: Manual load profile (hourly consumption in kW, 0-23 hours)
  # Will be replaced by real measurements over time
  manual_load_profile:
    "0": 0.2
    "1": 0.2
    "2": 0.15
    "3": 0.15
    "4": 0.15
    "5": 0.2
    "6": 0.5
    "7": 2.0
    "8": 1.5
    "9": 1.0
    "10": 0.8
    "11": 0.9
    "12": 1.2
    "13": 0.8
    "14": 0.7
    "15": 0.6
    "16": 0.7
    "17": 1.5
    "18": 2.0
    "19": 1.8
    "20": 1.2
    "21": 0.8
    "22": 0.5
    "23": 0.3

schema:
  inverter_ip: str
  inverter_port: port
  installer_password: password
  master_password: password
  max_charge_power: int(100,10000)
  battery_capacity: float(1.0,100.0)
  log_level: list(debug|info|warning|error)
  control_interval: int(10,300)
  mode_switch_hysteresis_seconds: int(60,3600)

  # Tibber Integration
  enable_tibber_optimization: bool
  price_threshold: float(0.5,1.0)
  auto_charge_below_soc: int(0,100)  # v1.2.0-beta.53: Allow any value 0-100
  auto_safety_soc: int(0,100)  # v1.2.0-beta.53: Allow any value 0-100
  auto_optimization_enabled: bool
  tibber_price_sensor: str?
  tibber_price_level_sensor: str?

  # Battery Sensors
  battery_soc_sensor: str

  # Energy sensors (cumulative kWh)
  grid_from_energy_sensor: str?
  grid_to_energy_sensor: str?
  battery_charge_from_grid_sensor: str?
  battery_charge_from_pv_sensor: str?
  battery_discharge_sensor: str?
  pv_energy_pv1_inverter1_sensor: str?
  pv_energy_pv2_inverter1_sensor: str?
  pv_energy_pv1_inverter2_sensor: str?
  pv_energy_pv2_inverter2_sensor: str?

  # Consumption Learning
  enable_consumption_learning: bool
  learning_period_days: int(7,90)

  # Forecast.Solar API
  enable_forecast_solar_api: bool
  forecast_solar_api_key: str?
  forecast_solar_latitude: float?
  forecast_solar_longitude: float?
  # Note: forecast_solar_planes is not validated by schema

  # Exclusion Sensors (optional - for loads that should not influence forecast)
  # e.g., EV charging, heat pump, etc.
  exclusion_sensor_1: str?
  exclusion_sensor_1_protect: bool?
  exclusion_sensor_1_threshold: float(0,50000)?
  exclusion_sensor_2: str?
  exclusion_sensor_2_protect: bool?
  exclusion_sensor_2_threshold: float(0,50000)?
  exclusion_sensor_3: str?
  exclusion_sensor_3_protect: bool?
  exclusion_sensor_3_threshold: float(0,50000)?

  # Scheduled Devices (optional - devices to run during cheap price periods)
  # e.g., pool pump, washing machine, etc.
  scheduled_device_1: str?
  scheduled_device_1_runtime: str?  # hours (number or entity ID)
  scheduled_device_1_power: str?    # watts (number or entity ID)
  scheduled_device_1_splittable: bool?
  scheduled_device_2: str?
  scheduled_device_2_runtime: str?
  scheduled_device_2_power: str?
  scheduled_device_2_splittable: bool?
  scheduled_device_3: str?
  scheduled_device_3_runtime: str?
  scheduled_device_3_power: str?
  scheduled_device_3_splittable: bool?

map:
  - data:rw
